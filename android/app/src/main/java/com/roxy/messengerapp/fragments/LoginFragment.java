package com.roxy.messengerapp.fragments;import android.content.Intent;import android.os.Bundle;import android.text.TextUtils;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Button;import android.widget.EditText;import android.widget.ProgressBar;import android.widget.TextView;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.fragment.app.Fragment;import androidx.navigation.Navigation;import com.roxy.messengerapp.R;import com.roxy.messengerapp.activities.MainActivity;import com.roxy.messengerapp.network.ApiClient;import com.roxy.messengerapp.network.ApiService;import com.roxy.messengerapp.network.SocketManager;import retrofit2.Call;import retrofit2.Callback;import retrofit2.Response;public class LoginFragment extends Fragment {    EditText email, password;    Button btn_login;    TextView tv_register;    ProgressBar progressBar;    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        return inflater.inflate(R.layout.fragment_login, container, false);    }    @Override    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {        super.onViewCreated(view, savedInstanceState);        email = view.findViewById(R.id.email);        password = view.findViewById(R.id.password);        btn_login = view.findViewById(R.id.btn_login);        tv_register = view.findViewById(R.id.tv_register);        btn_login.setOnClickListener(v -> {            String txt_email = email.getText().toString().trim();            String txt_password = password.getText().toString().trim();            if (TextUtils.isEmpty(txt_email) || TextUtils.isEmpty(txt_password)) {                Toast.makeText(getContext(), "Заполните все поля", Toast.LENGTH_SHORT).show();                return;            }            login(txt_email, txt_password);        });        tv_register.setOnClickListener(v -> {            Navigation.findNavController(v).navigate(R.id.action_login_to_register);        });    }    private void login(String email, String password) {        // Показываем загрузку        btn_login.setEnabled(false);        btn_login.setText("Вход...");        ApiService.LoginRequest request = new ApiService.LoginRequest(email, password);        ApiClient.getApi().login(request).enqueue(new Callback<ApiService.AuthResponse>() {            @Override            public void onResponse(Call<ApiService.AuthResponse> call, Response<ApiService.AuthResponse> response) {                btn_login.setEnabled(true);                btn_login.setText("Войти");                if (response.isSuccessful() && response.body() != null) {                    ApiService.AuthResponse authResponse = response.body();                    // Сохраняем токен                    ApiClient.setToken(requireContext(), authResponse.token);                    // Подключаем сокет                    SocketManager.getInstance().connect(authResponse.token);                    Toast.makeText(getContext(), "Добро пожаловать, " + authResponse.user.getUsername(), Toast.LENGTH_SHORT).show();                    // Переход в MainActivity                    Intent intent = new Intent(requireActivity(), MainActivity.class);                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK | Intent.FLAG_ACTIVITY_NEW_TASK);                    startActivity(intent);                    requireActivity().finish();                } else {                    // Ошибка от сервера                    String errorMsg = "Неверный email или пароль";                    try {                        if (response.errorBody() != null) {                            errorMsg = response.errorBody().string();                        }                    } catch (Exception e) {                        e.printStackTrace();                    }                    Toast.makeText(getContext(), errorMsg, Toast.LENGTH_SHORT).show();                }            }            @Override            public void onFailure(Call<ApiService.AuthResponse> call, Throwable t) {                btn_login.setEnabled(true);                btn_login.setText("Войти");                Toast.makeText(getContext(), "Ошибка сети: " + t.getMessage(), Toast.LENGTH_SHORT).show();            }        });    }}